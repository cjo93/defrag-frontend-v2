# Defrag Deployment Guide

This guide details the deployment of the complete Defrag system, including Frontend (`defrag.app`) and Backend (`api.defrag.app`).

## Architecture

*   **Frontend**: `defrag-web` (Next.js App Router). Deployed to `defrag.app`.
*   **Backend**: `defrag-api` (Next.js App Router). Deployed to `api.defrag.app`.
*   **CDN**: Cloudflare R2. Mapped to `assets.defrag.app`.
*   **Database**: Supabase.
*   **Video Generation**: AWS Lambda (via Remotion).

## 1. Backend Deployment (`defrag-api`)

1.  **Repository**: Connect the `defrag-api` repository (this repo) to Vercel.
2.  **Project Name**: `defrag-api`.
3.  **Root Directory**: `/` (root).
4.  **Framework Preset**: Next.js.
5.  **Environment Variables**:
    *   `SUPABASE_URL`: Your Supabase URL.
    *   `SUPABASE_SERVICE_ROLE_KEY`: Your Supabase Service Role Key (Critical for admin/jobs).
    *   `NEXT_PUBLIC_SUPABASE_URL`: Your Supabase URL.
    *   `DEFRAG_ADMIN_KEY`: Secret key for manual admin access.
    *   `CRON_SECRET`: Auto-generated by Vercel Cron.
    *   `R2_ENDPOINT`: `https://<account_id>.r2.cloudflarestorage.com`
    *   `R2_ACCESS_KEY_ID`: R2 Access Key.
    *   `R2_SECRET_ACCESS_KEY`: R2 Secret Key.
    *   `R2_BUCKET`: Your bucket name (e.g., `defrag-assets`).
    *   `R2_PUBLIC_BASE_URL`: `https://assets.defrag.app`
    *   `STRIPE_SECRET_KEY`: Live Secret Key.
    *   `STRIPE_WEBHOOK_SECRET`: Live Webhook Signing Secret.
    *   `STRIPE_PRICE_BLUEPRINT`: Price ID.
    *   `STRIPE_PRICE_OS`: Price ID.
    *   `AI_GATEWAY_URL`: `https://ai-gateway.vercel.sh/v1`
    *   `OPENAI_API_KEY`: OpenAI API Key.
    *   **Phase 4 Video Vars** (Future):
        *   `REMOTION_AWS_ACCESS_KEY_ID`
        *   `REMOTION_AWS_SECRET_ACCESS_KEY`
        *   `REMOTION_AWS_REGION`
        *   `REMOTION_BUCKET`

6.  **Database Migrations**:
    *   Run `supabase/migrations/0001_init.sql`.
    *   Run `supabase/migrations/0002_phase4_video.sql`.

## 2. Frontend Deployment (`defrag-web`)

The frontend code resides in a separate repository (`defrag-web`).

1.  **Repository**: Connect `defrag-web` to Vercel.
2.  **Project Name**: `defrag-web`.
3.  **Environment Variables**:
    *   `NEXT_PUBLIC_SUPABASE_URL`: Your Supabase URL.
    *   `NEXT_PUBLIC_SUPABASE_ANON_KEY`: Your Supabase Anon Key.
    *   `NEXT_PUBLIC_API_URL`: `https://api.defrag.app` (**CRITICAL**)
    *   **DO NOT** set any service keys or stripe secrets here.

## 3. DNS Configuration

*   `defrag.app` (A/CNAME) -> Vercel (`defrag-web`).
*   `www.defrag.app` (CNAME) -> Vercel (`defrag-web`).
*   `api.defrag.app` (CNAME) -> Vercel (`defrag-api`).
*   `assets.defrag.app` (CNAME) -> Cloudflare R2 (or proxied).

## 4. Phase 4 Video Implementation

The Phase 4 Video feature is currently **scaffolded**.
*   **Code**: `remotion/` directory contains the basic Remotion setup.
*   **API**: `POST /api/v1/admin/render-video` is implemented but returns `501 Not Implemented`.
*   **Completion**: To fully enable video generation:
    1.  Implement the visual composition in `remotion/Video.tsx`.
    2.  Update `app/api/v1/admin/render-video/route.ts` to trigger the Remotion Lambda render.
    3.  Deploy the Remotion Lambda function using `@remotion/lambda`.
